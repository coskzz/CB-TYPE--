<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>管理ダッシュボード｜CB TYPE 診断</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --primary:#6C5CE7;--accent:#00A86B;
  --bg:#F7F8FC;--surface:#FFFFFF;--surface2:#F0F2F8;
  --border:#E2E8F0;--text:#1A1A2E;--text-sub:#64748B;
  --radius:16px;--shadow:0 2px 16px rgba(0,0,0,.07);
}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
  background:var(--bg);color:var(--text);min-height:100dvh;
  display:flex;flex-direction:column;align-items:center;line-height:1.7;
}
.container{width:100%;max-width:680px;padding:48px 20px 80px}
h1{font-size:1.5rem;font-weight:800;color:var(--primary);margin-bottom:4px}
.subtitle{color:var(--text-sub);font-size:.85rem;margin-bottom:32px}
.panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:32px 28px;box-shadow:var(--shadow)}
label{display:block;font-size:.85rem;font-weight:600;color:var(--text-sub);margin-bottom:8px}
input[type="password"]{
  width:100%;padding:14px 16px;border:2px solid var(--border);border-radius:10px;
  font-size:1rem;background:var(--surface2);color:var(--text);outline:none;
  transition:border-color .2s;margin-bottom:20px;
}
input:focus{border-color:var(--primary)}
.btn{
  display:inline-flex;align-items:center;gap:8px;padding:14px 32px;
  border:none;border-radius:60px;font-size:.95rem;font-weight:700;
  cursor:pointer;transition:all .2s;color:#fff;width:100%;justify-content:center;
  background:linear-gradient(135deg,var(--primary),var(--accent));
  box-shadow:0 4px 24px rgba(108,92,231,.3);
}
.btn:hover{opacity:.9;transform:translateY(-1px)}
.note{margin-top:16px;font-size:.78rem;color:var(--text-sub);text-align:center;line-height:1.6}
.code-wrap{position:relative;margin:16px 0}
.code-block{
  background:#1A1A2E;color:#A8E063;font-family:"Courier New",monospace;
  font-size:.78rem;line-height:1.6;padding:20px;border-radius:12px;
  white-space:pre;overflow-x:auto;max-height:400px;overflow-y:auto;
}
.copy-btn{
  position:absolute;top:10px;right:10px;
  background:rgba(255,255,255,.15);color:#fff;border:none;
  border-radius:8px;padding:6px 12px;font-size:.75rem;cursor:pointer;
  transition:background .2s;
}
.copy-btn:hover{background:rgba(255,255,255,.3)}
.copy-btn.copied{background:#00A86B}
details{margin-top:24px}
summary{
  font-size:.85rem;font-weight:600;color:var(--text-sub);cursor:pointer;
  padding:12px 0;border-top:1px solid var(--border);
}
summary:hover{color:var(--primary)}
.steps{counter-reset:step;list-style:none;padding:16px 0 0}
.steps li{
  counter-increment:step;display:flex;gap:12px;align-items:flex-start;
  margin-bottom:12px;font-size:.85rem;
}
.steps li::before{
  content:counter(step);min-width:24px;height:24px;border-radius:50%;
  background:var(--primary);color:#fff;font-weight:700;font-size:.75rem;
  display:grid;place-items:center;flex-shrink:0;margin-top:2px;
}
</style>
</head>
<body>
<div class="container">
  <h1>管理ダッシュボード</h1>
  <p class="subtitle">CB TYPE 診断 ／ 回答データ管理</p>

  <div class="panel">
    <h2 style="font-size:1.05rem;font-weight:700;margin-bottom:20px">パスワードを入力してダッシュボードを開く</h2>
    <label for="pass">管理パスワード</label>
    <input type="password" id="pass" placeholder="パスワードを入力"
      onkeydown="if(event.key==='Enter')openDashboard()">
    <button class="btn" onclick="openDashboard()">ダッシュボードを開く →</button>
    <p class="note">ダッシュボードは別タブで開きます。<br>GASページ内でパスワードを確認します。</p>
  </div>

  <!-- GAS更新ガイド -->
  <details>
    <summary>GASコードの更新が必要な場合はこちら</summary>
    <ol class="steps">
      <li>Apps Scriptエディタを開き、既存コードを全選択（Ctrl+A）して削除</li>
      <li>下のコードをコピーして貼り付け → 保存（Ctrl+S）</li>
      <li>「デプロイ」→「デプロイを管理」→ 鉛筆アイコン → バージョン「新しいバージョン」→「デプロイ」</li>
    </ol>
    <div class="code-wrap">
      <pre id="gas-code" class="code-block"></pre>
      <button class="copy-btn" id="copy-btn" onclick="copyGAS()">コピー</button>
    </div>
  </details>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxuFasSFzxGpZoOnSjFlGFz9GWVapCQsKyH1M0hqv-7g20MpduXCOo2S8Z-wR1trk2H/exec';

function openDashboard(){
  const pass = document.getElementById('pass').value.trim();
  if(!pass){ alert('パスワードを入力してください'); return; }
  window.open(GAS_URL + '#' + encodeURIComponent(pass), '_blank');
}

function copyGAS(){
  const code = document.getElementById('gas-code').textContent;
  navigator.clipboard.writeText(code).then(function(){
    const btn = document.getElementById('copy-btn');
    btn.textContent = 'コピー完了 ✓';
    btn.classList.add('copied');
    setTimeout(function(){ btn.textContent = 'コピー'; btn.classList.remove('copied'); }, 2000);
  });
}

document.getElementById('gas-code').textContent = `var ADMIN_PASSWORD = 'helloCB46';
var SHEET_NAME = 'responses';

var TYPE_LABELS = {reporter:'レポーター型',arbitrage:'アービトラージ型',collab:'コラボ型',prosumer:'プロシューマー型',uber:'ウーバーイーツ型'};
var TYPE_COLORS = {reporter:'#DC2626',arbitrage:'#0891B2',collab:'#D97706',prosumer:'#7C3AED',uber:'#DB2777'};
var TYPE_ORDER = ['reporter','arbitrage','collab','prosumer','uber'];

function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(SHEET_NAME);
    if (!sheet) {
      sheet = ss.insertSheet(SHEET_NAME);
      sheet.appendRow(['timestamp','type','reporter','arbitrage','collab','prosumer','uber','ua','ref']);
      sheet.setFrozenRows(1);
    }
    sheet.appendRow([
      new Date().toISOString(), data.type||'',
      data.scores&&data.scores.reporter||0, data.scores&&data.scores.arbitrage||0,
      data.scores&&data.scores.collab||0, data.scores&&data.scores.prosumer||0,
      data.scores&&data.scores.uber||0,
      (data.ua||'').substring(0,200), (data.ref||'').substring(0,200)
    ]);
    return ContentService.createTextOutput(JSON.stringify({status:'ok'}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch(err) {
    return ContentService.createTextOutput(JSON.stringify({status:'error',msg:err.message}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return HtmlService.createHtmlOutput(getLoginHtml())
    .setTitle('CB TYPE 管理ダッシュボード')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function getDashboard(pass) {
  if (pass !== ADMIN_PASSWORD) return {ok: false};
  var rows = getData();
  return {ok: true, html: renderDashboard(rows)};
}

function getLoginHtml() {
  return '<html lang="ja"><head><meta charset="UTF-8"><title>CB TYPE 管理</title>' +
    '<style>*{box-sizing:border-box;margin:0;padding:0}' +
    'body{font-family:sans-serif;background:#F7F8FC;min-height:100vh;display:flex;align-items:center;justify-content:center}' +
    '.p{background:#fff;border:1px solid #E2E8F0;border-radius:16px;padding:40px;width:420px;max-width:95%}' +
    'h1{font-size:1.2rem;font-weight:800;color:#6C5CE7;margin-bottom:20px}' +
    'input{width:100%;padding:13px;border:2px solid #E2E8F0;border-radius:10px;font-size:1rem;background:#F0F2F8;outline:none;margin-bottom:14px}' +
    'input:focus{border-color:#6C5CE7}' +
    'button{width:100%;padding:14px;background:linear-gradient(135deg,#6C5CE7,#00A86B);color:#fff;border:none;border-radius:60px;font-size:.95rem;font-weight:700;cursor:pointer}' +
    '.e{color:#DC2626;font-size:.85rem;margin-top:10px;text-align:center;display:none}</style></head>' +
    '<body><div class="p"><h1>管理ダッシュボード</h1>' +
    '<input type="password" id="pw" placeholder="パスワード" onkeydown="if(event.key===\'Enter\')go()">' +
    '<button id="b" onclick="go()">ログイン →</button>' +
    '<p class="e" id="e">パスワードが正しくありません</p></div>' +
    '<script>function go(){' +
    'var p=document.getElementById("pw").value.trim();if(!p)return;' +
    'document.getElementById("b").textContent="読み込み中...";' +
    'document.getElementById("e").style.display="none";' +
    'google.script.run' +
    '.withSuccessHandler(function(r){' +
    'if(r&&r.ok){document.open();document.write(r.html);document.close();}' +
    'else{document.getElementById("e").style.display="block";document.getElementById("b").textContent="ログイン →";}' +
    '})' +
    '.withFailureHandler(function(){' +
    'document.getElementById("e").style.display="block";' +
    'document.getElementById("b").textContent="ログイン →";' +
    '})' +
    '.getDashboard(p);}' +
    'var h=location.hash.replace("#","");' +
    'if(h){document.getElementById("pw").value=decodeURIComponent(h);go();}' +
    '<\\/script></body></html>';
}

function getData() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) return [];
  var values = sheet.getDataRange().getValues();
  if (values.length <= 1) return [];
  var headers = values[0];
  return values.slice(1).map(function(row) {
    var obj = {};
    headers.forEach(function(h,i){ obj[h]=row[i]; });
    return obj;
  });
}

function renderDashboard(rows) {
  var total = rows.length;
  var counts = {reporter:0,arbitrage:0,collab:0,prosumer:0,uber:0};
  rows.forEach(function(r){ if(counts[r.type]!==undefined) counts[r.type]++; });

  var sorted = TYPE_ORDER.slice().sort(function(a,b){ return counts[b]-counts[a]; });
  var chartHtml = '';
  sorted.forEach(function(t) {
    var n = counts[t], pct = total>0 ? Math.round(n/total*100) : 0;
    chartHtml += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">' +
      '<div style="width:140px;text-align:right;font-size:13px;font-weight:600;flex-shrink:0">' + TYPE_LABELS[t] + '</div>' +
      '<div style="flex:1;background:#F0F2F8;border-radius:4px;height:22px;overflow:hidden">' +
        '<div style="height:100%;width:'+pct+'%;background:'+TYPE_COLORS[t]+';border-radius:4px;min-width:'+(n>0?2:0)+'px"></div>' +
      '</div>' +
      '<div style="width:90px;font-size:13px;color:#64748B">'+n+'人 ('+pct+'%)</div>' +
    '</div>';
  });

  var tbodyHtml = '';
  if (rows.length === 0) {
    tbodyHtml = '<tr><td colspan="3" style="padding:32px;text-align:center;color:#64748B">まだ回答がありません</td></tr>';
  } else {
    rows.slice().reverse().slice(0,100).forEach(function(r) {
      var d = r.timestamp ? new Date(r.timestamp).toLocaleString('ja-JP') : '-';
      var tn = TYPE_LABELS[r.type]||r.type||'-', tc = TYPE_COLORS[r.type]||'#888';
      tbodyHtml += '<tr>' +
        '<td style="padding:10px 14px;border-bottom:1px solid #E2E8F0;font-size:13px">' + d + '</td>' +
        '<td style="padding:10px 14px;border-bottom:1px solid #E2E8F0"><span style="background:'+tc+';color:#fff;padding:3px 10px;border-radius:60px;font-size:12px;font-weight:700">'+tn+'</span></td>' +
        '<td style="padding:10px 14px;border-bottom:1px solid #E2E8F0;font-family:monospace;font-size:12px;color:#64748B">R:'+(r.reporter||0)+' A:'+(r.arbitrage||0)+' C:'+(r.collab||0)+' P:'+(r.prosumer||0)+' U:'+(r.uber||0)+'</td>' +
      '</tr>';
    });
  }

  return '<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8">' +
    '<meta name="viewport" content="width=device-width,initial-scale=1">' +
    '<title>CB TYPE 管理ダッシュボード</title></head>' +
    '<body style="font-family:-apple-system,BlinkMacSystemFont,Hiragino Kaku Gothic ProN,sans-serif;background:#F7F8FC;color:#1A1A2E;margin:0;padding:32px 20px 80px">' +
    '<div style="max-width:900px;margin:0 auto">' +
    '<h1 style="font-size:1.4rem;font-weight:800;color:#6C5CE7;margin-bottom:4px">管理ダッシュボード</h1>' +
    '<p style="color:#64748B;font-size:13px;margin-bottom:28px">CB TYPE 診断 ／ 総回答数: <strong style="color:#1A1A2E">'+total+'</strong></p>' +
    '<div style="background:#fff;border:1px solid #E2E8F0;border-radius:16px;padding:28px;margin-bottom:20px">' +
    '<p style="font-size:12px;font-weight:700;color:#64748B;margin-bottom:16px;text-transform:uppercase;letter-spacing:.05em">タイプ別分布</p>' +
    chartHtml +
    '</div>' +
    '<div style="background:#fff;border:1px solid #E2E8F0;border-radius:16px;padding:28px">' +
    '<p style="font-size:12px;font-weight:700;color:#64748B;margin-bottom:16px;text-transform:uppercase;letter-spacing:.05em">回答履歴（直近100件）</p>' +
    '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse">' +
    '<thead><tr style="background:#F0F2F8">' +
    '<th style="padding:10px 14px;text-align:left;font-size:12px;font-weight:700;color:#64748B;border-bottom:2px solid #E2E8F0">日時</th>' +
    '<th style="padding:10px 14px;text-align:left;font-size:12px;font-weight:700;color:#64748B;border-bottom:2px solid #E2E8F0">タイプ</th>' +
    '<th style="padding:10px 14px;text-align:left;font-size:12px;font-weight:700;color:#64748B;border-bottom:2px solid #E2E8F0">スコア詳細</th>' +
    '</tr></thead><tbody>' + tbodyHtml + '</tbody></table></div>' +
    '</div>' +
    '<p style="font-size:12px;color:#64748B;margin-top:16px;text-align:right">最終更新: '+new Date().toLocaleString('ja-JP')+'</p>' +
    '</div></body></html>';
}`;
</script>
</body>
</html>
