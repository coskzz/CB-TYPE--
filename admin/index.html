<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>管理ダッシュボード｜CB TYPE 診断</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --primary:#6C5CE7;--accent:#00A86B;
  --bg:#F7F8FC;--surface:#FFFFFF;--surface2:#F0F2F8;
  --border:#E2E8F0;--text:#1A1A2E;--text-sub:#64748B;
  --reporter:#DC2626;--arbitrage:#0891B2;--collab:#D97706;
  --prosumer:#7C3AED;--uber:#DB2777;
  --radius:16px;--shadow:0 2px 16px rgba(0,0,0,.07);
}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
  background:var(--bg);color:var(--text);min-height:100dvh;
  display:flex;flex-direction:column;align-items:center;line-height:1.7;
}
.container{width:100%;max-width:900px;padding:32px 20px 80px}
h1{font-size:1.5rem;font-weight:800;color:var(--primary);margin-bottom:4px}
.subtitle{color:var(--text-sub);font-size:.85rem;margin-bottom:32px}

/* ── Panels ── */
.panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:32px 28px;box-shadow:var(--shadow);margin-bottom:24px}
.panel.hidden{display:none}
.panel h2{font-size:1.1rem;font-weight:700;margin-bottom:16px;color:var(--text)}

/* ── Form ── */
.form-group{margin-bottom:16px}
label{display:block;font-size:.85rem;font-weight:600;color:var(--text-sub);margin-bottom:6px}
input[type="text"],input[type="password"]{
  width:100%;padding:12px 16px;border:2px solid var(--border);border-radius:10px;
  font-size:.95rem;background:var(--surface2);color:var(--text);outline:none;
  transition:border-color .2s;
}
input:focus{border-color:var(--primary)}
.btn{
  display:inline-flex;align-items:center;gap:8px;padding:12px 28px;
  border:none;border-radius:60px;font-size:.9rem;font-weight:700;
  cursor:pointer;transition:all .2s;color:#fff;
  background:linear-gradient(135deg,var(--primary),var(--accent));
}
.btn:hover{opacity:.9;transform:translateY(-1px)}
.btn-sm{
  padding:7px 18px;font-size:.8rem;border-radius:60px;border:none;
  cursor:pointer;font-weight:600;transition:all .2s;
}
.btn-outline{
  background:none;border:2px solid var(--border);color:var(--text-sub);border-radius:60px;
  padding:7px 18px;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s;
}
.btn-outline:hover{border-color:var(--primary);color:var(--primary)}

/* ── GAS code block ── */
.code-wrap{position:relative;margin:16px 0}
.code-block{
  background:#1A1A2E;color:#A8E063;font-family:"Courier New",monospace;
  font-size:.78rem;line-height:1.6;padding:20px;border-radius:12px;
  white-space:pre;overflow-x:auto;max-height:320px;overflow-y:auto;
}
.copy-btn{
  position:absolute;top:10px;right:10px;
  background:rgba(255,255,255,.15);color:#fff;border:none;
  border-radius:8px;padding:6px 12px;font-size:.75rem;cursor:pointer;
  transition:background .2s;
}
.copy-btn:hover{background:rgba(255,255,255,.3)}
.copy-btn.copied{background:var(--accent)}

/* ── Stats cards ── */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;margin-bottom:24px}
.stat-card{
  background:var(--surface2);border-radius:12px;padding:16px 20px;text-align:center;
}
.stat-card .num{font-size:2rem;font-weight:800;color:var(--primary);line-height:1}
.stat-card .label{font-size:.78rem;color:var(--text-sub);margin-top:4px}

/* ── Distribution chart ── */
.chart-row{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.chart-label{width:130px;font-size:.82rem;font-weight:600;flex-shrink:0;text-align:right}
.chart-bar-wrap{flex:1;background:var(--surface2);border-radius:4px;height:22px;overflow:hidden}
.chart-bar{height:100%;border-radius:4px;transition:width .6s ease;min-width:2px}
.chart-count{width:100px;font-size:.8rem;color:var(--text-sub);flex-shrink:0}

/* ── Table ── */
.table-wrap{overflow-x:auto;margin-top:24px}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th{background:var(--surface2);padding:10px 14px;text-align:left;font-weight:700;font-size:.78rem;color:var(--text-sub);border-bottom:2px solid var(--border)}
td{padding:10px 14px;border-bottom:1px solid var(--border);vertical-align:middle}
tr:hover td{background:rgba(108,92,231,.03)}
.type-badge{
  display:inline-block;padding:3px 10px;border-radius:60px;font-size:.75rem;font-weight:700;color:#fff;
}
.scores-detail{font-family:monospace;font-size:.75rem;color:var(--text-sub)}

/* ── Alert ── */
.alert{
  padding:12px 16px;border-radius:10px;font-size:.85rem;margin-bottom:16px;
  background:rgba(220,38,38,.08);border:1px solid rgba(220,38,38,.2);color:#DC2626;
}
.alert.hidden{display:none}

/* ── Steps ── */
.steps{counter-reset:step;list-style:none;padding:0}
.steps li{
  counter-increment:step;display:flex;gap:12px;align-items:flex-start;
  margin-bottom:16px;font-size:.9rem;
}
.steps li::before{
  content:counter(step);min-width:28px;height:28px;border-radius:50%;
  background:var(--primary);color:#fff;font-weight:700;font-size:.8rem;
  display:grid;place-items:center;flex-shrink:0;margin-top:2px;
}

/* ── Tabs ── */
.tab-header{display:flex;gap:8px;margin-bottom:20px;border-bottom:2px solid var(--border);padding-bottom:0}
.tab-btn{
  padding:10px 20px;border:none;background:none;font-size:.9rem;font-weight:600;
  color:var(--text-sub);cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px;
  transition:all .2s;
}
.tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}

/* ── Responsive ── */
@media(max-width:600px){
  .chart-label{width:90px;font-size:.75rem}
  .chart-count{width:80px}
  .stats-grid{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>
<div class="container">
  <h1>管理ダッシュボード</h1>
  <p class="subtitle">CB TYPE 診断 ／ 回答データ管理</p>

  <!-- ====== SETUP PANEL ====== -->
  <div id="setup-panel" class="panel hidden">
    <h2>初期設定</h2>
    <p style="margin-bottom:20px;font-size:.9rem;color:var(--text-sub)">
      回答データを収集するため、Google Apps Scriptのセットアップが必要です。<br>以下の手順に従って設定してください。
    </p>

    <ol class="steps">
      <li><a href="https://sheets.google.com" target="_blank" rel="noopener">Google スプレッドシート</a>を新規作成します。</li>
      <li>メニューから「拡張機能」→「Apps Script」を開きます。</li>
      <li>下のコードをコピーして貼り付け、ファイルを保存します（Ctrl+S）。</li>
      <li>「デプロイ」→「新しいデプロイ」→「ウェブアプリ」を選択し、<br>
        「次のユーザーとして実行：自分」、「アクセスできるユーザー：全員」に設定してデプロイします。</li>
      <li>表示されたウェブアプリURLをコピーして下のフォームに貼り付けます。</li>
    </ol>

    <div class="code-wrap">
      <pre id="gas-code" class="code-block">// =============================
// CB TYPE 診断 - Google Apps Script
// =============================
// ⚠️ デプロイ前にパスワードを変更してください
var ADMIN_PASSWORD = 'YOUR_ADMIN_PASSWORD_HERE';
var SHEET_NAME = 'responses';

function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(SHEET_NAME);
    if (!sheet) {
      sheet = ss.insertSheet(SHEET_NAME);
      sheet.appendRow([
        'timestamp','type',
        'reporter','arbitrage','collab','prosumer','uber',
        'ua','ref'
      ]);
      sheet.setFrozenRows(1);
    }
    sheet.appendRow([
      new Date().toISOString(),
      data.type || '',
      data.scores && data.scores.reporter || 0,
      data.scores && data.scores.arbitrage || 0,
      data.scores && data.scores.collab || 0,
      data.scores && data.scores.prosumer || 0,
      data.scores && data.scores.uber || 0,
      (data.ua || '').substring(0, 200),
      (data.ref || '').substring(0, 200)
    ]);
    return ContentService
      .createTextOutput(JSON.stringify({status: 'ok'}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch(err) {
    return ContentService
      .createTextOutput(JSON.stringify({status: 'error', msg: err.message}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  var callback = e.parameter.callback;
  var auth = e.parameter.auth;
  var result;

  if (auth !== ADMIN_PASSWORD) {
    result = JSON.stringify({error: 'unauthorized'});
  } else {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(SHEET_NAME);
    if (!sheet) {
      result = JSON.stringify({rows: [], total: 0});
    } else {
      var values = sheet.getDataRange().getValues();
      if (values.length <= 1) {
        result = JSON.stringify({rows: [], total: 0});
      } else {
        var headers = values[0];
        var rows = values.slice(1).map(function(row) {
          var obj = {};
          headers.forEach(function(h, i) { obj[h] = row[i]; });
          return obj;
        });
        result = JSON.stringify({rows: rows, total: rows.length});
      }
    }
  }

  if (callback) {
    return ContentService
      .createTextOutput(callback + '(' + result + ')')
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
  return ContentService
    .createTextOutput(result)
    .setMimeType(ContentService.MimeType.JSON);
}</pre>
      <button class="copy-btn" id="copy-btn" onclick="copyGAS()">コピー</button>
    </div>

    <div id="setup-alert" class="alert hidden"></div>
    <div class="form-group">
      <label>GAS ウェブアプリURL</label>
      <input type="text" id="setup-url" placeholder="https://script.google.com/macros/s/..." />
    </div>
    <div class="form-group">
      <label>管理パスワード（GASコード内に設定したもの）</label>
      <input type="password" id="setup-pass" placeholder="パスワードを入力" />
    </div>
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <button class="btn" onclick="saveSetup()">設定を保存してログイン</button>
    </div>
  </div>

  <!-- ====== LOGIN PANEL ====== -->
  <div id="login-panel" class="panel hidden">
    <h2>管理者ログイン</h2>
    <div id="login-alert" class="alert hidden"></div>
    <div class="form-group">
      <label>パスワード</label>
      <input type="password" id="login-pass" placeholder="パスワードを入力"
        onkeydown="if(event.key==='Enter')login()" />
    </div>
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <button class="btn" onclick="login()">ログイン</button>
      <button class="btn-outline" onclick="showSetup()">設定を変更</button>
      <a id="gas-test-link" href="#" target="_blank" rel="noopener"
        style="font-size:.8rem;color:var(--text-sub);text-decoration:underline;align-self:center"
        onclick="this.href=gasUrl">GAS接続テスト（別タブで開く）</a>
    </div>
  </div>

  <!-- ====== DASHBOARD PANEL ====== -->
  <div id="dashboard-panel" class="panel hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:20px">
      <h2 style="margin:0">回答ダッシュボード</h2>
      <div style="display:flex;gap:8px">
        <button class="btn-sm" style="background:var(--surface2);color:var(--text-sub);border:1px solid var(--border)" onclick="refresh()">更新</button>
        <button class="btn-outline" onclick="logout()">ログアウト</button>
      </div>
    </div>

    <!-- Tab navigation -->
    <div class="tab-header">
      <button class="tab-btn active" onclick="switchTab('overview')">概要</button>
      <button class="tab-btn" onclick="switchTab('recent')">回答履歴</button>
    </div>

    <!-- Overview tab -->
    <div id="tab-overview">
      <div id="stats-grid" class="stats-grid"></div>
      <h3 style="font-size:.9rem;font-weight:700;color:var(--text-sub);margin-bottom:16px;letter-spacing:.05em;text-transform:uppercase">タイプ別分布</h3>
      <div id="chart"></div>
    </div>

    <!-- Recent tab -->
    <div id="tab-recent" class="hidden">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>日時</th>
              <th>タイプ</th>
              <th>スコア詳細</th>
            </tr>
          </thead>
          <tbody id="recent-tbody"></tbody>
        </table>
      </div>
    </div>

    <p id="last-updated" style="font-size:.75rem;color:var(--text-sub);margin-top:20px;text-align:right"></p>
  </div>

</div>

<script>
const TYPE_LABELS = {
  reporter:  'レポーター型',
  arbitrage: 'アービトラージ型',
  collab:    'コラボ型',
  prosumer:  'プロシューマー型',
  uber:      'ウーバーイーツ型'
};
const TYPE_COLORS = {
  reporter:  '#DC2626',
  arbitrage: '#0891B2',
  collab:    '#D97706',
  prosumer:  '#7C3AED',
  uber:      '#DB2777'
};
const TYPE_ORDER = ['reporter','arbitrage','collab','prosumer','uber'];

const DEFAULT_GAS_URL = 'https://script.google.com/macros/s/AKfycbxuFasSFzxGpZoOnSjFlGFz9GWVapCQsKyH1M0hqv-7g20MpduXCOo2S8Z-wR1trk2H/exec';
let gasUrl   = localStorage.getItem('cbAdmin_gasUrl') || DEFAULT_GAS_URL;
let savedPass = localStorage.getItem('cbAdmin_pass') || '';

// ── Init ──
function init(){
  if(!gasUrl){
    showPanel('setup-panel');
  } else if(!savedPass){
    showPanel('login-panel');
  } else {
    showPanel('dashboard-panel');
    fetchData(savedPass);
  }
}

function showPanel(id){
  ['setup-panel','login-panel','dashboard-panel'].forEach(p => {
    document.getElementById(p).classList.toggle('hidden', p !== id);
  });
}

// ── Setup ──
function showSetup(){
  document.getElementById('setup-url').value = gasUrl;
  showPanel('setup-panel');
}

function saveSetup(){
  const url  = document.getElementById('setup-url').value.trim();
  const pass = document.getElementById('setup-pass').value.trim();
  const alertEl = document.getElementById('setup-alert');

  if(!url || !pass){
    alertEl.textContent = 'URLとパスワードを両方入力してください。';
    alertEl.classList.remove('hidden');
    return;
  }
  alertEl.classList.add('hidden');

  gasUrl    = url;
  savedPass = pass;
  localStorage.setItem('cbAdmin_gasUrl', gasUrl);
  localStorage.setItem('cbAdmin_pass', savedPass);

  showPanel('dashboard-panel');
  fetchData(savedPass);
}

// ── Login ──
function login(){
  const pass    = document.getElementById('login-pass').value.trim();
  const alertEl = document.getElementById('login-alert');
  if(!pass){
    alertEl.textContent = 'パスワードを入力してください。';
    alertEl.classList.remove('hidden');
    return;
  }
  alertEl.classList.add('hidden');
  showPanel('dashboard-panel');
  fetchData(pass);
}

function logout(){
  localStorage.removeItem('cbAdmin_pass');
  savedPass = '';
  document.getElementById('login-pass').value = '';
  showPanel('login-panel');
}

// ── JSONP helper (CORSを回避してGASに接続) ──
function fetchJSONP(url){
  return new Promise(function(resolve, reject){
    const cbName = '__gasCb' + Date.now();
    const script = document.createElement('script');
    const timer = setTimeout(function(){
      cleanup();
      reject(new Error('タイムアウト（10秒）'));
    }, 10000);

    function cleanup(){
      clearTimeout(timer);
      delete window[cbName];
      if(script.parentNode) script.parentNode.removeChild(script);
    }

    window[cbName] = function(data){
      cleanup();
      resolve(data);
    };

    script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cbName;
    script.onerror = function(){
      cleanup();
      reject(new Error('GASへの接続に失敗しました'));
    };
    document.head.appendChild(script);
  });
}

// ── Data ──
async function fetchData(pass){
  setDashboardLoading();
  try {
    const json = await fetchJSONP(`${gasUrl}?auth=${encodeURIComponent(pass)}`);

    if(json.error){
      localStorage.removeItem('cbAdmin_pass');
      savedPass = '';
      showPanel('login-panel');
      document.getElementById('login-alert').textContent = 'パスワードが正しくありません。';
      document.getElementById('login-alert').classList.remove('hidden');
      return;
    }

    savedPass = pass;
    localStorage.setItem('cbAdmin_pass', pass);
    renderDashboard(json.rows || []);
  } catch(err){
    showPanel('login-panel');
    document.getElementById('login-alert').textContent = `接続エラー: ${err.message}`;
    document.getElementById('login-alert').classList.remove('hidden');
  }
}

function refresh(){
  fetchData(savedPass);
}

function setDashboardLoading(){
  document.getElementById('stats-grid').innerHTML = '<p style="color:var(--text-sub);font-size:.9rem">読み込み中...</p>';
  document.getElementById('chart').innerHTML = '';
  document.getElementById('recent-tbody').innerHTML = '';
}

// ── Render ──
function renderDashboard(rows){
  const total = rows.length;

  // Count by type
  const counts = {};
  TYPE_ORDER.forEach(t => counts[t] = 0);
  rows.forEach(r => { if(r.type in counts) counts[r.type]++; });

  // ── Stats grid ──
  const topEntry = TYPE_ORDER.reduce((a,b) => counts[a] >= counts[b] ? a : b);
  document.getElementById('stats-grid').innerHTML = `
    <div class="stat-card">
      <div class="num">${total}</div>
      <div class="label">総回答数</div>
    </div>
    <div class="stat-card">
      <div class="num" style="color:${TYPE_COLORS[topEntry]}">${TYPE_LABELS[topEntry].replace('型','')}</div>
      <div class="label">最多タイプ</div>
    </div>
    <div class="stat-card">
      <div class="num">${total > 0 ? Math.round(counts[topEntry]/total*100) : 0}%</div>
      <div class="label">最多タイプ割合</div>
    </div>
  `;

  // ── Distribution chart ──
  const sorted = [...TYPE_ORDER].sort((a,b) => counts[b] - counts[a]);
  let chartHtml = '';
  sorted.forEach(type => {
    const count = counts[type];
    const pct   = total > 0 ? Math.round(count / total * 100) : 0;
    chartHtml += `
      <div class="chart-row">
        <div class="chart-label">${TYPE_LABELS[type]}</div>
        <div class="chart-bar-wrap">
          <div class="chart-bar" style="width:${pct}%;background:${TYPE_COLORS[type]}"></div>
        </div>
        <div class="chart-count">${count}人 (${pct}%)</div>
      </div>`;
  });
  document.getElementById('chart').innerHTML = chartHtml;

  // ── Recent responses table ──
  const recent = [...rows].reverse().slice(0, 100);
  let tbodyHtml = '';
  if(recent.length === 0){
    tbodyHtml = '<tr><td colspan="3" style="text-align:center;color:var(--text-sub);padding:32px">まだ回答がありません</td></tr>';
  } else {
    recent.forEach(r => {
      const dateStr = r.timestamp
        ? new Date(r.timestamp).toLocaleString('ja-JP', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})
        : '-';
      const typeName  = TYPE_LABELS[r.type] || r.type || '-';
      const typeColor = TYPE_COLORS[r.type]  || '#888';
      tbodyHtml += `
        <tr>
          <td>${dateStr}</td>
          <td><span class="type-badge" style="background:${typeColor}">${typeName}</span></td>
          <td class="scores-detail">R:${r.reporter||0} A:${r.arbitrage||0} C:${r.collab||0} P:${r.prosumer||0} U:${r.uber||0}</td>
        </tr>`;
    });
  }
  document.getElementById('recent-tbody').innerHTML = tbodyHtml;
  document.getElementById('last-updated').textContent =
    `最終更新: ${new Date().toLocaleString('ja-JP')}`;
}

// ── Tabs ──
function switchTab(name){
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('tab-overview').classList.toggle('hidden', name !== 'overview');
  document.getElementById('tab-recent').classList.toggle('hidden', name !== 'recent');
}

// ── Copy GAS code ──
function copyGAS(){
  const code = document.getElementById('gas-code').textContent;
  navigator.clipboard.writeText(code).then(() => {
    const btn = document.getElementById('copy-btn');
    btn.textContent = 'コピー完了 ✓';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'コピー'; btn.classList.remove('copied'); }, 2000);
  }).catch(() => {
    alert('コードをコピーできませんでした。手動で選択してコピーしてください。');
  });
}

init();
</script>
</body>
</html>
